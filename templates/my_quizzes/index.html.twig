{% extends 'layout.html.twig' %}

{% block layout_title %}My Quizzes{% endblock %}

{% block content %}

    <h2 style="text-align: center; padding-bottom: 1em">My Quizzes</h2>

    {# Section to display the filters for the quizzes #}
    <div class="container" style="margin-top: 1em; margin-bottom: 4em">
        <div class="row">
            <div class="col-md-6">
                <label for="completionFilter">Filter by Completion:</label>
                <select id="completionFilter" class="form-select">
                    <option value="">All</option>
                    <option value="completed">Completed</option>
                    <option value="incomplete">Incomplete</option>
                </select>
            </div>
            <div class="col-md-6">
                <label for="topicFilter">Filter by Topic:</label>
                <select id="topicFilter" class="form-select">
                    <option value="">All</option>
                    {% for topic in topics %}
                        <option value="{{ topic }}">{{ topic }}</option>
                    {% endfor %}
                </select>
            </div>
        </div>
    </div>

    <table class="table">
        <thead>
        <tr>
            <th style="text-align: center" >Date Assigned</th>
            <th style="text-align: center">Quiz ID</th>
            <th style="text-align: center">Topic</th>
            <th style="text-align: center">Assigned by</th>
            <th style="text-align: center">Deadline</th>
            <th style="text-align: center">Overdue</th>
            <th style="text-align: center">Mark</th>
            <th style="text-align: center">Passed</th>
            <th style="text-align: center"></th>
        </tr>
        </thead>

        <!-Section to display the quizzes based on the filters selected. The list is initially empty and will be populated by the script below. ->
        <tbody id="quizList">

            {% if assignedQuizzes|length == 0 %}
            <tr>
                <td colspan="9" style="text-align: center">
                    <div class="alert alert-warning" role="alert">
                        There are no Quizzes!
                    </div>
                </td>
            </tr>

            {% endif %}

        </tbody>

    </table>
{% endblock %}

{% block javascripts %}
{{ parent() }}
    <script>

        document.addEventListener("DOMContentLoaded", function() {

            // Function to fetch quizzes from the server based on the selected filters. List all quizzes if no filters are selected.
            function fetchQuizzes(completionFilter, topicFilter) {
                const url = `/fetch-my-filtered-quizzes?completion=${completionFilter}&topic=${topicFilter}`;

                fetch(url)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Network response was not ok');
                        }
                        return response.json();
                    })
                    .then(data => {
                        const quizList = document.getElementById('quizList');
                        quizList.innerHTML = ''; // Clear existing quiz list

                        data.forEach(quiz => {

                            let completeButtonHTML = quiz.assignedQuizIsCompleted === false ?
                                `<a href="/my/quizzes/${quiz.assignedQuizId}" class="btn btn-primary">Take Quiz</a>` :

                                `<a href="/my/quizzes/${quiz.assignedQuizId}/details" class="btn btn-primary">View Quiz</a>`;

                            const quizRow = `
                        <tr>
                            <td style="text-align: center">${quiz.generatedDate}</td>
                            <td style="text-align: center">${quiz.quizId}</td>
                            <td style="text-align: center">${quiz.topic}</td>
                            <td style="text-align: center">${quiz.assigner}</td>
                            <td style="text-align: center">${quiz.deadline}</td>
                            <td style="text-align: center">${quiz.overdue === 'Yes' ? '<span class="badge bg-danger">Yes</span>' : '<span class="badge bg-success">No</span>'}</td>
                            <td style="text-align: center">${quiz.assignedQuizIsCompleted === true ? quiz.assignedQuizMark + ' %' : 'N/A'}</td>
                            <td style="text-align: center">${
                                quiz.assignedQuizIsCompleted
                                    ? (quiz.assignedQuizIsPassed
                                        ? '<i class="bi bi-check-circle-fill text-success"></i>'
                                        : '<i class="bi bi-x-circle-fill text-danger"></i>')
                                    : '<i class="bi bi-circle text-muted"></i>'
                            }</td>
                            <td style="text-align: center">${completeButtonHTML}</td>
                        </tr>
                    `;
                            quizList.insertAdjacentHTML('beforeend', quizRow);
                        });
                    })
                    .catch(error => console.error('Error fetching quizzes:', error));
            }

            // Event listeners for the filters
            document.getElementById('completionFilter').addEventListener('change', function() {
                const completionFilter = this.value;
                const topicFilter = document.getElementById('topicFilter').value;
                fetchQuizzes(completionFilter, topicFilter);
            });
            document.getElementById('topicFilter').addEventListener('change', function() {
                const topicFilter = this.value;
                const completionFilter = document.getElementById('completionFilter').value;
                fetchQuizzes(completionFilter, topicFilter);
            });

            // Initial fetch all the quizzes upon page load
            fetchQuizzes('', '');
        });

    </script>

{% endblock %}